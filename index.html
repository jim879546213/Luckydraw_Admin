<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>獎品後台管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'PingFang TC', sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 將 Firebase 實體掛載到 window 方便 React 使用
        const firebaseConfig = {
            apiKey: "AIzaSyD4GqSck1qhMR_iK26YYbYKr_iY2Py0kAo",
            authDomain: "luckydraw-5ffc4.firebaseapp.com",
            projectId: "luckydraw-5ffc4",
            storageBucket: "luckydraw-5ffc4.firebasestorage.app",
            messagingSenderId: "60338826922",
            appId: "1:60338826922:web:80a5187410e88755baead3"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.fsDoc = doc;
        window.fsOnSnapshot = onSnapshot;
        window.fsSetDoc = setDoc;
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 內嵌圖示組件 ---
        const Icon = ({ name, className = "" }) => {
            const baseSize = (className.includes('w-') || className.includes('h-')) ? '' : 'w-5 h-5';
            
            const icons = {
                Plus: <path d="M5 12h14m-7-7v14" />,
                Trash2: <path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2m-6 9h4m-4-4h4" />,
                Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8" />,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8m0 0V2m0 6h-6m6 4a9 9 0 1 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16m0 0v6m0-6h6" />,
                Package: <path d="M16.5 9.4 7.5 4.21M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16zM3.27 6.96 12 12.01l8.73-5.05M12 22.08V12" />,
                Edit3: <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />,
                Check: <polyline points="20 6 9 17 4 12" />,
                AlertCircle: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="12" />
                        <line x1="12" y1="16" x2="12.01" y2="16" />
                    </React.Fragment>
                ),
                RotateCcw: <path d="M1 4v6h6M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
            };
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={`${baseSize} ${className}`}
                >
                    {icons[name]}
                </svg>
            );
        };

        const DOC_ID = "main_lottery";

        function App() {
            const [prizes, setPrizes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState({ text: '', type: '' });
            const [isEditing, setIsEditing] = useState(null);
            const [newPrize, setNewPrize] = useState({ name: '', count: 0 });

            useEffect(() => {
                const checkDb = setInterval(() => {
                    if (window.db) {
                        clearInterval(checkDb);
                        startListening();
                    }
                }, 100);
                
                const startListening = () => {
                    window.fsOnSnapshot(window.fsDoc(window.db, "games", DOC_ID), (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.data();
                            const sortedPrizes = (data.prizes || []).sort((a, b) => a.id - b.id);
                            setPrizes(sortedPrizes);
                        }
                        setLoading(false);
                    }, (error) => {
                        showMsg("連線失敗：" + error.message, "error");
                        setLoading(false);
                    });
                };
            }, []);

            const showMsg = (text, type = 'success') => {
                setMessage({ text, type });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const saveToCloud = async (updatedList) => {
                setSaving(true);
                try {
                    await window.fsSetDoc(window.fsDoc(window.db, "games", DOC_ID), {
                        prizes: updatedList,
                        updatedAt: new Date().toISOString()
                    });
                    showMsg("雲端數據已同步成功！");
                } catch (error) {
                    showMsg("儲存失敗：" + error.message, "error");
                } finally {
                    setSaving(false);
                }
            };

            // 新增：重置為預設庫存功能 (移植自原本的 game.html)
            const handleResetDefault = async () => {
                if(!window.confirm("⚠️ 警告：這將清除目前所有資料並重置為「預設庫存」。\n\n確定要繼續嗎？")) return;
                
                const initialData = [
                    { id: 1, name: "Ｂ賞", count: 5 },
                    { id: 2, name: "Ｄ賞", count: 7 },
                    { id: 3, name: "Ｃ賞", count: 18 },
                    { id: 4, name: "Ａ賞", count: 70 }
                ];
                
                // 直接呼叫 saveToCloud，它會處理 setDoc 並觸發 onSnapshot 更新本地 state
                await saveToCloud(initialData);
                showMsg("已重置為初始狀態！");
            };

            const handleAddPrize = () => {
                if (!newPrize.name) return showMsg("請輸入獎項名稱", "error");
                const nextId = prizes.length > 0 ? Math.max(...prizes.map(p => p.id)) + 1 : 1;
                const newList = [...prizes, { id: nextId, name: newPrize.name, count: parseInt(newPrize.count) || 0 }];
                setPrizes(newList);
                setNewPrize({ name: '', count: 0 });
                saveToCloud(newList);
            };

            const handleDelete = (id) => {
                if (!window.confirm("確定要刪除此獎項嗎？")) return;
                const newList = prizes.filter(p => p.id !== id);
                setPrizes(newList);
                saveToCloud(newList);
            };

            const handleUpdateItem = (id, field, value) => {
                const newList = prizes.map(p => {
                    if (p.id === id) {
                        return { ...p, [field]: field === 'count' ? parseInt(value) || 0 : value };
                    }
                    return p;
                });
                setPrizes(newList);
            };

            const totalPrizes = prizes.reduce((sum, p) => sum + p.count, 0);

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <Icon name="RefreshCw" className="w-8 h-8 text-blue-500 animate-spin" />
                        <span className="ml-2 text-slate-600 font-medium">載入中...</span>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="bg-indigo-600 p-2 rounded-lg text-white">
                                    <Icon name="Package" />
                                </div>
                                <h1 className="text-xl font-bold text-slate-800">抽獎後台管理</h1>
                            </div>
                            <div className="flex items-center space-x-4">
                                {saving && <span className="text-xs text-slate-400 animate-pulse">同步中...</span>}
                                <div className="text-right hidden sm:block">
                                    <p className="text-xs text-slate-500 font-semibold">系統狀態</p>
                                    <p className="text-sm text-green-600 font-medium flex items-center">
                                        <span className="w-2 h-2 bg-green-500 rounded-full mr-2"></span> 連線正常
                                    </p>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto px-4 py-8">
                        {message.text && (
                            <div className={`mb-6 p-4 rounded-xl flex items-center shadow-sm border ${
                                message.type === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'
                            }`}>
                                <Icon name="AlertCircle" className="mr-3 w-5 h-5" />
                                <span className="font-medium">{message.text}</span>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <p className="text-slate-500 text-sm font-medium mb-1">總剩餘獎項</p>
                                <p className="text-3xl font-bold text-slate-900">{totalPrizes} <span className="text-base font-normal text-slate-400">份</span></p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <p className="text-slate-500 text-sm font-medium mb-1">獎品種類</p>
                                <p className="text-3xl font-bold text-slate-900">{prizes.length} <span className="text-base font-normal text-slate-400">種</span></p>
                            </div>
                            
                            {/* 操作區塊 */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center space-y-3">
                                <button onClick={() => saveToCloud(prizes)} disabled={saving} className="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl transition-all disabled:opacity-50">
                                    <Icon name="Save" className="mr-2 w-5 h-5" /> 儲存目前修改
                                </button>
                                <button onClick={handleResetDefault} disabled={saving} className="w-full flex items-center justify-center bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-600 font-semibold py-2 rounded-xl transition-all text-sm border border-slate-200">
                                    <Icon name="RotateCcw" className="mr-2 w-4 h-4" /> 重置為預設庫存
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                            <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <h2 className="font-bold text-slate-700">獎項清單 (即時監控中)</h2>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="text-slate-400 text-xs uppercase border-b border-slate-100">
                                            <th className="px-6 py-4">ID</th>
                                            <th className="px-6 py-4">獎品名稱</th>
                                            <th className="px-6 py-4">庫存</th>
                                            <th className="px-6 py-4 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {prizes.map((prize) => (
                                            <tr key={prize.id} className="hover:bg-slate-50/30 transition-colors">
                                                <td className="px-6 py-4 text-slate-400 text-sm">#{prize.id}</td>
                                                <td className="px-6 py-4">
                                                    {isEditing === prize.id ? (
                                                        <input type="text" value={prize.name} onChange={(e) => handleUpdateItem(prize.id, 'name', e.target.value)} className="w-full px-2 py-1 border border-indigo-300 rounded" />
                                                    ) : (
                                                        <span className="font-semibold text-slate-700">{prize.name}</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4">
                                                    {isEditing === prize.id ? (
                                                        <input type="number" value={prize.count} onChange={(e) => handleUpdateItem(prize.id, 'count', e.target.value)} className="w-20 px-2 py-1 border border-indigo-300 rounded" />
                                                    ) : (
                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${prize.count > 0 ? 'bg-blue-50 text-blue-600' : 'bg-red-50 text-red-600'}`}>{prize.count}</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-right">
                                                    <div className="flex justify-end space-x-1">
                                                        {isEditing === prize.id ? (
                                                            <button onClick={() => { setIsEditing(null); saveToCloud(prizes); }} className="p-1.5 text-green-600 hover:bg-green-50 rounded"><Icon name="Check" /></button>
                                                        ) : (
                                                            <button onClick={() => setIsEditing(prize.id)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded"><Icon name="Edit3" /></button>
                                                        )}
                                                        <button onClick={() => handleDelete(prize.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><Icon name="Trash2" /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="bg-indigo-900 rounded-2xl shadow-lg p-6 text-white">
                            <h2 className="text-lg font-bold mb-4 flex items-center">
                                <Icon name="Plus" className="mr-2 w-5 h-5" /> 新增獎項
                            </h2>
                            <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                <div className="sm:col-span-2">
                                    <label className="block text-indigo-200 text-xs mb-1">名稱</label>
                                    <input type="text" value={newPrize.name} onChange={(e) => setNewPrize({...newPrize, name: e.target.value})} className="w-full bg-indigo-800 border-none rounded-xl px-4 py-2" placeholder="例：特獎" />
                                </div>
                                <div>
                                    <label className="block text-indigo-200 text-xs mb-1">數量</label>
                                    <input type="number" value={newPrize.count} onChange={(e) => setNewPrize({...newPrize, count: e.target.value})} className="w-full bg-indigo-800 border-none rounded-xl px-4 py-2" />
                                </div>
                                <div className="flex items-end">
                                    <button onClick={handleAddPrize} className="w-full bg-white text-indigo-900 font-bold py-2 rounded-xl">新增</button>
                                </div>
                            </div>
                        </div>
                    </main>
                    <footer className="text-center py-6 text-slate-400 text-xs">
                        Firestore Cloud Sync Active
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>