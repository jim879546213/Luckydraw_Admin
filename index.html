<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>創友回娘家 - 雲端即時抽獎</title>
    <style>
        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2.5rem;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 420px;
            width: 100%;
            border: 4px solid #fff;
        }
        h1 { color: #d35400; margin-bottom: 0.5rem; }
        .gift-box-container { width: 160px; height: 160px; margin: 0 auto 30px auto; position: relative; }
        .gacha-box {
            width: 100%; height: 100%; background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 8px solid #f0f0f0; transition: all 0.3s;
        }
        .gacha-icon { width: 80px; height: 80px; }
        .shaking { animation: shake 0.4s infinite; border-color: #ffd700; }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        button {
            background: linear-gradient(to right, #ff758c, #ff7eb3);
            color: white; border: none; padding: 15px 50px;
            font-size: 1.3rem; border-radius: 50px; cursor: pointer; font-weight: bold;
        }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #result-area { margin-top: 25px; min-height: 60px; font-size: 1.2rem; font-weight: bold; opacity: 0; transition: 0.5s; }
        .show-result { opacity: 1 !important; }
        .result-highlight { color: #ff4757; font-size: 1.8rem; display: block; }
        #status-msg { position: fixed; bottom: 10px; font-size: 12px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h1>創友回娘家</h1>
    <div id="prize-count-info" style="color: #7f8c8d; margin-bottom: 20px;">連線中...</div>

    <div class="gift-box-container">
        <div class="gacha-box" id="display-icon">
            <svg class="gacha-icon" viewBox="0 0 64 64"><path fill="#FFD700" d="M10 28h44v28H10z"/><path fill="#FF4757" d="M2 18h60v10H2z"/><path fill="#FF4757" d="M32 18c0-8-8-12-12-6s4 12 12 6z"/></svg>
        </div>
    </div>

    <button id="draw-btn" disabled>請稍候...</button>
    <div id="result-area"></div>
</div>

<div id="status-msg">Firebase 系統運作中</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase 配置
    const firebaseConfig = {
        apiKey: "AIzaSyD4GqSck1qhMR_iK26YYbYKr_iY2Py0kAo",
        authDomain: "luckydraw-5ffc4.firebaseapp.com",
        projectId: "luckydraw-5ffc4",
        storageBucket: "luckydraw-5ffc4.firebasestorage.app",
        messagingSenderId: "60338826922",
        appId: "1:60338826922:web:80a5187410e88755baead3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DOC_ID = "main_lottery"; 
    
    let currentPrizes = [];

    // 即時監聽雲端數據
    onSnapshot(doc(db, "games", DOC_ID), (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.data();
            currentPrizes = data.prizes;
            
            const total = currentPrizes.reduce((sum, p) => sum + p.count, 0);
            document.getElementById('prize-count-info').textContent = `目前剩餘獎項：${total} 份`;
            
            const btn = document.getElementById('draw-btn');
            if (total > 0) {
                btn.disabled = false;
                btn.textContent = "立即抽獎";
            } else {
                btn.disabled = true;
                btn.textContent = "獎項已抽完";
            }
        } else {
            document.getElementById('prize-count-info').textContent = "系統維護中 (資料庫未初始化)";
        }
    });

    // 抽獎邏輯
    window.drawPrize = async () => {
        const btn = document.getElementById('draw-btn');
        const resultArea = document.getElementById('result-area');
        const iconBox = document.getElementById('display-icon');

        if(btn.disabled) return;

        btn.disabled = true;
        resultArea.classList.remove('show-result');
        iconBox.classList.add('shaking');

        const pool = currentPrizes.filter(p => p.count > 0);
        if (pool.length === 0) return;

        const picked = pool[Math.floor(Math.random() * pool.length)];

        const newPrizes = currentPrizes.map(p => {
            if (p.id === picked.id) return { ...p, count: p.count - 1 };
            return p;
        });

        try {
            await setDoc(doc(db, "games", DOC_ID), {
                prizes: newPrizes,
                updatedAt: new Date().toISOString()
            });

            setTimeout(() => {
                iconBox.classList.remove('shaking');
                resultArea.innerHTML = `恭喜獲得<span class="result-highlight">${picked.name}</span>`;
                resultArea.classList.add('show-result');
            }, 1200);

        } catch (e) {
            console.error(e);
            alert("抽獎同步失敗，請檢查網路連線");
            btn.disabled = false;
            iconBox.classList.remove('shaking');
        }
    };

    document.getElementById('draw-btn').onclick = window.drawPrize;
</script>
</body>
</html>