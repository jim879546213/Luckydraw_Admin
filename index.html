<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µå‹å›å¨˜å®¶ - è–èª•é›²ç«¯æŠ½ç</title>
    <style>
        :root {
            --xmas-red: #d42426;
            --xmas-green: #165b33;
            --xmas-gold: #f8b229;
            --snow-white: #f0f4f8;
            --bg-gradient: linear-gradient(135deg, #1a472a 0%, #0d2b1d 100%);
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* é˜²æ­¢é›ªèŠ±å°è‡´æ»¾å‹•æ¢ */
            position: relative;
        }

        /* é›ªèŠ±ç‰¹æ•ˆå±¤ */
        .snow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            color: #fff;
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(105vh); }
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 420px;
            width: 100%;
            /* ç³–æœæ‰‹æ–é‚Šæ¡†é¢¨æ ¼ */
            border: 8px solid transparent;
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            background-image: linear-gradient(to right, #fff, #fff), repeating-linear-gradient(45deg, var(--xmas-red) 0, var(--xmas-red) 15px, #ffffff 15px, #ffffff 30px);
            position: relative;
            z-index: 10; /* ç¢ºä¿åœ¨é›ªèŠ±ä¹‹ä¸Š */
        }

        /* è£é£¾æ€§æ¨™é¡Œ */
        h1 { 
            color: var(--xmas-red); 
            margin-bottom: 0.5rem; 
            font-weight: 900;
            text-shadow: 2px 2px 0px rgba(220, 220, 220, 0.5);
        }
        
        h1::before, h1::after {
            content: 'ğŸ„';
            margin: 0 10px;
        }

        #prize-count-info {
            color: var(--xmas-green);
            font-weight: bold;
            background: #e8f5e9;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .gift-box-container { 
            width: 160px; 
            height: 160px; 
            margin: 10px auto 30px auto; 
            position: relative; 
        }
        
        .gacha-box {
            width: 100%; 
            height: 100%; 
            background: #fff8e1; /* æ·¡é‡‘è‰²èƒŒæ™¯ */
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 6px solid var(--xmas-gold); 
            box-shadow: 0 0 15px rgba(248, 178, 41, 0.4);
            transition: all 0.3s;
        }
        
        .gacha-icon { width: 90px; height: 90px; }
        
        /* ç¦®ç‰©ç›’é…è‰²èª¿æ•´ */
        .gift-base { fill: var(--xmas-red); }
        .gift-ribbon { fill: var(--xmas-gold); }
        
        .shaking { animation: shake 0.5s infinite; border-color: var(--xmas-red); }
        
        @keyframes shake {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-15deg); }
            40% { transform: rotate(10deg); }
            60% { transform: rotate(-10deg); }
            80% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }

        button {
            background: linear-gradient(to bottom, #d42426, #b31d1f);
            color: white; 
            border: none; 
            padding: 15px 50px;
            font-size: 1.3rem; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 6px 0 #8e1719, 0 10px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        /* æŒ‰éˆ•ä¸Šçš„é›ªäº®åå…‰ */
        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            20% { left: 100%; }
            100% { left: 100%; }
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #8e1719, 0 4px 4px rgba(0,0,0,0.2);
        }

        button:disabled { 
            background: #95a5a6; 
            box-shadow: none;
            cursor: not-allowed; 
            transform: none;
        }
        
        #result-area { 
            margin-top: 25px; 
            min-height: 60px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            opacity: 0; 
            transition: 0.5s;
            color: #2c3e50;
        }
        
        .show-result { opacity: 1 !important; }
        
        .result-highlight { 
            color: var(--xmas-red); 
            font-size: 1.8rem; 
            display: block; 
            margin-top: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #status-msg { 
            position: fixed; 
            bottom: 10px; 
            font-size: 12px; 
            color: rgba(255,255,255,0.6); 
            z-index: 5;
        }
    </style>
</head>
<body>

<!-- é›ªèŠ±å®¹å™¨ -->
<div class="snow-container" id="snow-container"></div>

<div class="container">
    <h1>å‰µå‹å›å¨˜å®¶</h1>
    <div id="prize-count-info">é€£ç·šä¸­...</div>

    <div class="gift-box-container">
        <div class="gacha-box" id="display-icon">
            <!-- èª¿æ•´å¾Œçš„ SVGï¼Œä½¿ç”¨ class æ§åˆ¶é¡è‰² -->
            <svg class="gacha-icon" viewBox="0 0 64 64">
                <!-- ç¦®ç‰©ç›’ä¸»é«” -->
                <path class="gift-base" d="M10 28h44v28H10z"/>
                <!-- è“‹å­ -->
                <path class="gift-base" d="M2 18h60v10H2z"/>
                <!-- ç·å¸¶ (å‚ç›´) -->
                <path class="gift-ribbon" d="M28 28h8v28h-8z"/>
                <path class="gift-ribbon" d="M28 18h8v10h-8z"/>
                <!-- è´è¶çµ -->
                <path class="gift-ribbon" d="M32 18c0-8-8-12-12-6s4 12 12 6z"/>
                <path class="gift-ribbon" d="M32 18c0-8 8-12 12-6s-4 12-12 6z"/>
            </svg>
        </div>
    </div>

    <button id="draw-btn" disabled>è«‹ç¨å€™...</button>
    <div id="result-area"></div>
</div>

<div id="status-msg">Firebase ç³»çµ±é‹ä½œä¸­ (æ•¸é‡æ¬Šé‡å¹³è¡¡å·²é–‹å•Ÿ)</div>

<script>
    // ç°¡å–®çš„é›ªèŠ±ç”Ÿæˆè…³æœ¬
    function createSnowflakes() {
        const container = document.getElementById('snow-container');
        const count = 30; // é›ªèŠ±æ•¸é‡
        
        for (let i = 0; i < count; i++) {
            const snowflake = document.createElement('div');
            snowflake.classList.add('snowflake');
            snowflake.textContent = 'â„';
            snowflake.style.left = Math.random() * 100 + 'vw';
            snowflake.style.animationDuration = Math.random() * 3 + 2 + 's'; // 2-5ç§’
            snowflake.style.opacity = Math.random();
            snowflake.style.fontSize = Math.random() * 10 + 10 + 'px';
            
            // éš¨æ©Ÿå»¶é²é–‹å§‹ï¼Œè®“é›ªèŠ±çœ‹èµ·ä¾†è‡ªç„¶
            snowflake.style.animationDelay = Math.random() * 5 + 's';
            
            container.appendChild(snowflake);
        }
    }
    createSnowflakes();
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyD4GqSck1qhMR_iK26YYbYKr_iY2Py0kAo",
        authDomain: "luckydraw-5ffc4.firebaseapp.com",
        projectId: "luckydraw-5ffc4",
        storageBucket: "luckydraw-5ffc4.firebasestorage.app",
        messagingSenderId: "60338826922",
        appId: "1:60338826922:web:80a5187410e88755baead3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DOC_ID = "main_lottery"; 
    
    let currentPrizes = [];

    // å³æ™‚ç›£è½é›²ç«¯æ•¸æ“š
    onSnapshot(doc(db, "games", DOC_ID), (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.data();
            currentPrizes = data.prizes;
            
            const total = currentPrizes.reduce((sum, p) => sum + p.count, 0);
            document.getElementById('prize-count-info').textContent = `ğŸ„ ç›®å‰å‰©é¤˜çé …ï¼š${total} ä»½`;
            
            const btn = document.getElementById('draw-btn');
            if (total > 0) {
                btn.disabled = false;
                btn.textContent = "ç«‹å³æŠ½ç";
            } else {
                btn.disabled = true;
                btn.textContent = "çé …å·²æŠ½å®Œ";
            }
        } else {
            document.getElementById('prize-count-info').textContent = "ç³»çµ±ç¶­è­·ä¸­ (è³‡æ–™åº«æœªåˆå§‹åŒ–)";
        }
    });

    // æŠ½çé‚è¼¯ (åŸºæ–¼å‰©é¤˜æ•¸é‡çš„åŠ æ¬Šæ¼”ç®—æ³•)
    window.drawPrize = async () => {
        const btn = document.getElementById('draw-btn');
        const resultArea = document.getElementById('result-area');
        const iconBox = document.getElementById('display-icon');

        if(btn.disabled) return;

        btn.disabled = true;
        resultArea.classList.remove('show-result');
        iconBox.classList.add('shaking');

        // éæ¿¾å‡ºå‰©é¤˜æ•¸é‡å¤§æ–¼ 0 çš„çå“
        const pool = currentPrizes.filter(p => p.count > 0);
        if (pool.length === 0) return;

        // è¨ˆç®—ç¸½æ¬Šé‡ (å‰©é¤˜ç¸½æ•¸)
        const totalWeight = pool.reduce((sum, p) => sum + p.count, 0);
        
        // ç”¢ç”Ÿ 0 åˆ° totalWeight ä¹‹é–“çš„éš¨æ©Ÿæ•¸
        let randomThreshold = Math.random() * totalWeight;
        let picked = null;

        // åŠ æ¬Šç¯©é¸é‚è¼¯ï¼šæ•¸é‡è¶Šå¤šä½”æ“šçš„éš¨æ©Ÿå€é–“è¶Šå¤§
        for (const prize of pool) {
            randomThreshold -= prize.count;
            if (randomThreshold <= 0) {
                picked = prize;
                break;
            }
        }

        // é˜²éŒ¯æ©Ÿåˆ¶ (æ­£å¸¸æƒ…æ³ä¸‹ picked ä¸æœƒç‚º null)
        if (!picked) picked = pool[0];

        // æº–å‚™æ›´æ–°æ•¸æ“š
        const newPrizes = currentPrizes.map(p => {
            if (p.id === picked.id) return { ...p, count: p.count - 1 };
            return p;
        });

        try {
            await setDoc(doc(db, "games", DOC_ID), {
                prizes: newPrizes,
                updatedAt: new Date().toISOString()
            });

            setTimeout(() => {
                iconBox.classList.remove('shaking');
                resultArea.innerHTML = `ğŸ… æ­å–œç²å¾—<span class="result-highlight">${picked.name}</span>`;
                resultArea.classList.add('show-result');
            }, 1200);

        } catch (e) {
            console.error(e);
            alert("æŠ½çåŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
            btn.disabled = false;
            iconBox.classList.remove('shaking');
        }
    };

    document.getElementById('draw-btn').onclick = window.drawPrize;
</script>
</body>
</html>